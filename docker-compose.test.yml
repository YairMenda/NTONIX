version: '3.8'

services:
  # Mock LLM backends for testing
  backend1:
    image: python:3.11-slim
    command: python /mock/simple_backend.py 8001
    volumes:
      - ./mock:/mock:ro
    expose:
      - "8001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 2s
      timeout: 2s
      retries: 3
      start_period: 2s

  backend2:
    image: python:3.11-slim
    command: python /mock/simple_backend.py 8002
    volumes:
      - ./mock:/mock:ro
    expose:
      - "8002"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 2s
      timeout: 2s
      retries: 3
      start_period: 2s

  backend3:
    image: python:3.11-slim
    command: python /mock/simple_backend.py 8003
    volumes:
      - ./mock:/mock:ro
    expose:
      - "8003"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 2s
      timeout: 2s
      retries: 3
      start_period: 2s

  # NTONIX proxy
  ntonix:
    build:
      context: .
      dockerfile: Dockerfile.build
    command: >
      ./build/ntonix
      --backends backend1:8001
      --backends backend2:8002
      --backends backend3:8003
    ports:
      - "8080:8080"
    depends_on:
      - backend1
      - backend2
      - backend3
